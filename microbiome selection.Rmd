---
title: "Microbiome selection"
author: "Jigyasa Arora and Sasha Mikheyev"
date: "2/16/2018"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE, fig.path='figures/', fig.width=5, fig.height=5 )
```

# Phenotypic analysis

generating the correct format for all the fly eclosion time files-

```{r loadLibraries, message=FALSE}
library("gridExtra")
library("scales")
library("RColorBrewer")
library("tidyverse") #dplyr package included
library(stringr)
library(nlme)
library(effects)
```


```{r loadData}
flydata <- read_csv("data/flydata.csv") %>% mutate( line = paste(subreplicates, round, diet, conditions)) %>% select(time = emergence_time, diet, round, selection = conditions, line) %>% filter(diet != "control")

flydata %>% ggplot(aes(time, fill=selection))+geom_histogram(position="dodge") + facet_grid(.~diet)
```

## Exploratory analysis

```{r plotData}
ggplot(flydata, aes(as.factor(round), time, color=selection) )+geom_boxplot()+facet_grid(.~diet)

ggplot(flydata, aes(as.factor(round), time,  color=selection) )+geom_boxplot()+facet_grid(diet~.)+theme_bw()

ggplot(flydata, aes(selection, time, group = selection, color = selection))+ geom_jitter(alpha=.1)+facet_grid(diet~as.factor(round))+theme_bw()
```

## Analalysis using vial as a random factor

```{r modRandom}
flydataFactors <- flydata %>% mutate(day = ifelse(time<225, 1, ifelse(time<240, 2, ifelse(time<270, 3, 4)))) %>% as.data.frame()
flydataFactors$selection <- factor(flydataFactors$selection)
flydataFactors$diet <- factor(flydataFactors$diet)
flydataFactors$day <- factor(flydataFactors$day)
mod2 <- lme(time ~ round * diet * selection , random=~1|line, method="ML", data = flydataFactors )
summary(mod2)

effect(term="round:selection", xlevels=list(selection=c("selection","noselection")), mod=mod2) %>% as.data.frame() %>% ggplot(aes(round,fit,color=selection))+geom_line()

effect(term="round:diet", xlevels=list(diet=c("control","nsd")), mod=mod2) %>% as.data.frame() %>% ggplot(aes(round,fit,color=diet))+geom_line()

effect(term="round:diet:selection", xlevels=list(selection=c("selection","noselection"),diet=c("control","nsd")), mod=mod2) %>% as.data.frame()%>% ggplot(aes(round,fit,color=selection,linetype=diet))+geom_line()

effect(term="round:diet:selection", xlevels=list(selection=c("selection","noselection"),diet=c("control","nsd")), mod=mod2) %>% as.data.frame()%>% ggplot(aes(round,fit,color=selection,linetype=diet))+geom_line()+geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.3)+ facet_grid(diet~., scales="free")

ggplot(flydataFactors, aes(day, fill=selection))+geom_histogram(stat="count", position="dodge") +facet_grid(.~diet)

flydata %>% group_by(diet, round, selection, line) %>% summarize(time = mean(time), flies = n())%>% filter(round == 5) %>% ggplot(aes(time, flies, color = round)) + geom_point() + facet_grid(.~diet, scales = "free") + stat_smooth(method="lm")

```

# Microbial analysis


```{r}
library(qiime2R)
library(phyloseq)
microbedat <- qza_to_phyloseq(features = "data/table.qza", taxonomy="data/taxonomy.qza", tree = "data/rooted-tree.qza", metadata = "data/metadata.txt") %>% subset_samples(Diet != "CD")

plot_richness(microbedat, "Round", measures = "Shannon", color = "Selection") + facet_grid(Diet~., scales = "free_y") + stat_smooth(method="lm") + theme_minimal()


```
